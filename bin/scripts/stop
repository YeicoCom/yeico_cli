#!/bin/bash

APP_NAME=$1
APP_RUN=/apps/$APP_NAME/bin/$APP_NAME
APP_TMP=/apps/$APP_NAME/tmp

panic() { 
    >&2 echo $1
    exit 1
}

mount -o remount,rw /apps || panic "Remount RW failure"

COUNTER=5
while true; do
    (mount | grep -v tmpfs | grep /apps | grep rw > /dev/null) && break
    COUNTER=$[$COUNTER-1]
    [ $COUNTER == "0" ] && panic "Remount RW timeout"
    sleep 1
done

# kills this script if not detached with &
$APP_RUN stop &

COUNTER=10
while true; do
    sleep 1
    # 'Device or resource busy' comes from kernel?
    # hard to suppress output
    umount $APP_TMP |& :
    rm -fr $APP_TMP |& :
    [ -e $APP_TMP ] || break
    COUNTER=$[$COUNTER-1]
    [ $COUNTER == "0" ] && panic "Umount tmp timeout"
done
